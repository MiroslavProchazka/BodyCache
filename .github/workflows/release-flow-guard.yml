name: Release Flow Guard

on:
  pull_request:
    branches:
      - staging
      - main

jobs:
  guard:
    name: enforce-promotion-direction
    runs-on: ubuntu-latest

    steps:
      - name: Validate source branch for release promotions
        env:
          BASE_REF: ${{ github.base_ref }}
          HEAD_REF: ${{ github.head_ref }}
        run: |
          echo "Validating promotion path $HEAD_REF -> $BASE_REF"

          if [ "$BASE_REF" = "staging" ] && [ "$HEAD_REF" != "dev" ]; then
            echo "Only PRs from dev are allowed into staging"
            exit 1
          fi

          if [ "$BASE_REF" = "main" ] && [ "$HEAD_REF" != "staging" ]; then
            echo "Only PRs from staging are allowed into main"
            exit 1
          fi

          echo "Promotion path is valid"
